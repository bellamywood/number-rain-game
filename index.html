<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hex Rain - Decimal to Hex Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #020617;
      color: #e5e7eb;
    }

    .game-shell {
      background: #020617;
      border-radius: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
      padding: 1.5rem 1.5rem 1.25rem;
      max-width: 820px;
      width: 100%;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      z-index: 1;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .game-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
    }

    .game-subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-top: 0.25rem;
      max-width: 420px;
      line-height: 1.35;
    }

    .score-panel {
      text-align: right;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .score-panel strong {
      color: #e5e7eb;
    }

    .controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .left-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .right-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.12s ease;
      white-space: nowrap;
    }

    .btn.secondary {
      background: #111827;
      box-shadow: none;
      border: 1px solid #4b5563;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
    }

    .label-small {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 0.1rem;
    }

    select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
    }

    .status-line {
      font-size: 0.85rem;
      min-height: 1.2em;
      color: #9ca3af;
      margin-bottom: 0.35rem;
    }

    .status-line.important {
      color: #fbbf24;
    }

    .status-line.success {
      color: #4ade80;
    }

    .status-line.error {
      color: #f97373;
    }

    .weights-row,
    .grid-row {
      display: grid;
      grid-template-columns: 110px 120px 120px 1fr;
      gap: 0.3rem;
      align-items: center;
    }

    .weights-row {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 0.25rem;
      padding: 0 0.15rem;
    }

    .weights-row .cell {
      text-align: center;
    }

    .weights-row .cell.target-head {
      text-align: left;
      padding-left: 0.25rem;
    }

    .weights-row .cell.value-head {
      text-align: right;
      padding-right: 0.25rem;
    }

    .grid-container {
      background: radial-gradient(circle at top, #0b1120, #020617 55%);
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.4rem 0.4rem 0.6rem;
      min-height: 260px;
      max-height: 360px;
      overflow: hidden;
      position: relative;
    }

    .grid-inner {
      max-height: 320px;
      overflow: hidden;
    }

    .grid-row {
      margin: 0.12rem 0;
      padding: 0.12rem 0.15rem;
      border-radius: 0.45rem;
      transition: background 0.15s ease, transform 0.1s ease,
        opacity 0.15s ease;
    }

    .grid-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.7);
    }

    .grid-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.35);
    }

    .cell {
      text-align: center;
      font-size: 0.85rem;
    }

    .cell.target {
      text-align: left;
      padding-left: 0.25rem;
      font-weight: 600;
    }

    .cell.value {
      text-align: right;
      padding-right: 0.25rem;
      font-feature-settings: "tnum" 1;
    }

    .cell.value.correct {
      color: #4ade80;
    }

    .cell.value.incorrect {
      color: #f97316;
    }

    .value-text {
      display: block;
      margin-bottom: 0.15rem;
    }

    .row-reset-btn {
      border: 1px solid #4b5563;
      background: #020617;
      color: #9ca3af;
      border-radius: 999px;
      padding: 0.05rem 0.6rem;
      font-size: 0.7rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .row-reset-btn:active {
      transform: scale(0.97);
    }

    .hex-digit {
      width: 100%;
      height: 32px;
      border-radius: 0.45rem;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.1s ease, border-color 0.1s ease;
    }

    .hex-digit:active {
      transform: scale(0.96);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
      border-color: #2563eb;
    }

    .mono-preview {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }

    .progress-wrapper {
      margin-top: 0.45rem;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #111827;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #22c55e, #eab308, #ef4444);
      transition: width 0.25s ease;
    }

    .info-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.45rem;
      font-size: 0.75rem;
      color: #6b7280;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .pill {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      border: 1px solid #374151;
      background: #020617;
    }

    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .sound-toggle input {
      accent-color: #22c55e;
    }

    .howto-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .howto-overlay.visible {
      display: flex;
    }

    .howto-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
    }

    .howto-card {
      position: relative;
      max-width: 420px;
      margin: 1rem;
      background: #020617;
      border-radius: 1rem;
      padding: 1rem 1.25rem 1.1rem;
      border: 1px solid #4b5563;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
      z-index: 60;
    }

    .howto-card h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }

    .howto-intro {
      font-size: 0.85rem;
      color: #d1d5db;
      margin: 0 0 0.5rem;
    }

    .howto-list {
      margin: 0 0 0.75rem 1.1rem;
      padding: 0;
      font-size: 0.8rem;
      color: #9ca3af;
      list-style: disc;
    }

    .howto-list li {
      margin-bottom: 0.25rem;
    }

    @media (max-width: 820px) {
      .game-shell {
        margin: 0.75rem;
        padding: 1.25rem 1rem 1rem;
      }

      .weights-row,
      .grid-row {
        grid-template-columns: 90px 100px 100px 1fr;
      }
    }

    @media (max-width: 520px) {
      body {
        align-items: stretch;
      }

      .game-shell {
        border-radius: 0;
        max-width: 100%;
        height: 100vh;
      }

      .grid-container {
        min-height: 230px;
      }

      .weights-row,
      .grid-row {
        grid-template-columns: 80px 80px 80px 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="game-shell" id="gameShell">
    <div class="game-header">
      <div>
        <h1 class="game-title" id="gameTitle">Hex Rain - Decimal to Hex</h1>
        <div class="game-subtitle" id="gameSubtitle">
          Each row shows a decimal number. Click the hex digits to make the
          matching hexadecimal value before the grid fills up.
        </div>
      </div>
      <div class="score-panel">
        <div>Score: <strong id="score">0</strong></div>
        <div>Rows solved: <strong id="rowsSolved">0</strong></div>
      </div>
    </div>

    <div class="controls-row">
      <div class="left-controls">
        <button class="btn" id="startBtn">Start</button>
        <button class="btn secondary" id="resetBtn">Restart Game</button>
      </div>
      <div class="right-controls">
        <div>
          <div class="label-small">Spawn speed</div>
          <select id="speedSelect">
            <option value="10000">Slow (x0.5)</option>
            <option value="8000" selected>Normal (x1)</option>
            <option value="5000">Fast (x2)</option>
          </select>
        </div>
        <div>
          <div class="label-small">Sound</div>
          <label class="sound-toggle">
            <input type="checkbox" id="soundToggle" checked />
            On
          </label>
        </div>
        <button class="btn secondary" id="howToBtn">How to play</button>
      </div>
    </div>

    <div id="status" class="status-line important">
      Press <strong>Start</strong> to begin. Match each target using the hex
      buttons.
    </div>

    <div class="weights-row">
      <div class="cell target-head" id="headerTarget">Target (dec)</div>
      <div class="cell" id="headerCol1">High hex digit</div>
      <div class="cell" id="headerCol2">Low hex digit</div>
      <div class="cell value-head" id="headerValue">Your value</div>
    </div>

    <div class="grid-container">
      <div id="grid" class="grid-inner"></div>
    </div>

    <div class="progress-wrapper">
      <div id="progressBar" class="progress-bar"></div>
    </div>

    <div class="info-footer">
      <div class="pill" id="infoTip">
        Decimal → Hex: 16 in decimal is <span class="mono-preview">10</span> in
        hex.
      </div>
      <div>Grid fills up = game over.</div>
    </div>
  </div>

  <div class="howto-overlay" id="howToOverlay">
    <div class="howto-backdrop" id="howToBackdrop"></div>
    <div class="howto-card">
      <h2 id="howToTitle">How to play</h2>
      <p id="howToIntro" class="howto-intro"></p>
      <ul id="howToList" class="howto-list"></ul>
      <button class="btn secondary" id="closeHowToBtn">Close</button>
    </div>
  </div>

  <script>
    // DOM elements
    const gridEl = document.getElementById("grid");
    const statusEl = document.getElementById("status");
    const scoreEl = document.getElementById("score");
    const rowsSolvedEl = document.getElementById("rowsSolved");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const speedSelect = document.getElementById("speedSelect");
    const soundToggle = document.getElementById("soundToggle");
    const progressBar = document.getElementById("progressBar");

    const howToBtn = document.getElementById("howToBtn");
    const howToOverlay = document.getElementById("howToOverlay");
    const howToBackdrop = document.getElementById("howToBackdrop");
    const howToTitleEl = document.getElementById("howToTitle");
    const howToIntroEl = document.getElementById("howToIntro");
    const howToListEl = document.getElementById("howToList");
    const closeHowToBtn = document.getElementById("closeHowToBtn");

    // Game state
    let rows = [];
    let nextId = 1;
    let score = 0;
    let rowsSolved = 0;
    const maxRows = 8;

    let running = false;
    let spawnTimer = null;

    let audioCtx = null;
    let soundOn = true;

    function randomTarget() {
      // 1–255 (fits in two hex digits, no zero to keep it challenging)
      return 1 + Math.floor(Math.random() * 255);
    }

    function toHex2(value) {
      return value.toString(16).toUpperCase().padStart(2, "0");
    }

    function spawnRow() {
      if (!running) return;

      if (rows.length >= maxRows) {
        gameOver("Grid is full! Game over.");
        return;
      }

      const row = {
        id: nextId++,
        target: randomTarget(),
        hi: 0,
        lo: 0,
      };

      rows.push(row);
      renderRows();
    }

    function getRowValue(row) {
      return row.hi * 16 + row.lo;
    }

    function findRowIndexById(id) {
      return rows.findIndex((r) => r.id === id);
    }

    function playBeep(type) {
      if (!soundOn) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;

      if (!audioCtx) {
        audioCtx = new Ctx();
      }

      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      let freq = 440;
      let duration = 0.15;

      if (type === "correct") {
        freq = 880;
        duration = 0.2;
      } else if (type === "incorrect") {
        freq = 220;
        duration = 0.25;
      }

      osc.type = "sine";
      osc.frequency.setValueAtTime(freq, now);

      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.15, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(now);
      osc.stop(now + duration + 0.02);
    }

    function handleDigitClick(rowId, nibble) {
      const index = findRowIndexById(rowId);
      if (index === -1) return;

      const row = rows[index];

      if (nibble === "hi") {
        row.hi = (row.hi + 1) % 16;
      } else {
        row.lo = (row.lo + 1) % 16;
      }

      const value = getRowValue(row);

      if (value === row.target) {
        score += getScorePerRow();
        rowsSolved += 1;
        rows.splice(index, 1);
        statusEl.textContent = `Correct! ${toHex2(
          value
        )} in hex = ${row.target} in decimal.`;
        statusEl.className = "status-line success";
        playBeep("correct");
      } else {
        statusEl.textContent = `Row ${rowId}: 0x${toHex2(
          value
        )} = ${value}. Match ${row.target}.`;
        statusEl.className = "status-line";
        playBeep("incorrect");
      }

      updateScores();
      renderRows();
    }

    function getScorePerRow() {
      const speed = parseInt(speedSelect.value, 10);
      if (speed === 10000) return 5;
      if (speed === 8000) return 10;
      if (speed === 5000) return 20;
      return 10;
    }

    function updateScores() {
      scoreEl.textContent = score;
      rowsSolvedEl.textContent = rowsSolved;
    }

    function updateProgressBar() {
      const fill = (rows.length / maxRows) * 100;
      progressBar.style.width = `${Math.min(fill, 100)}%`;
    }

    function resetRowValues(row) {
      row.hi = 0;
      row.lo = 0;
    }

    function renderRows() {
      gridEl.innerHTML = "";

      rows.forEach((row) => {
        const rowEl = document.createElement("div");
        rowEl.className = "grid-row";
        rowEl.dataset.id = row.id;

        const targetCell = document.createElement("div");
        targetCell.className = "cell target";
        targetCell.textContent = row.target;

        const hiCell = document.createElement("div");
        const loCell = document.createElement("div");
        const valueCell = document.createElement("div");
        valueCell.className = "cell value";

        const hiBtn = document.createElement("button");
        hiBtn.className = "hex-digit";
        hiBtn.textContent = row.hi.toString(16).toUpperCase();
        hiBtn.dataset.nibble = "hi";

        const loBtn = document.createElement("button");
        loBtn.className = "hex-digit";
        loBtn.textContent = row.lo.toString(16).toUpperCase();
        loBtn.dataset.nibble = "lo";

        hiCell.appendChild(hiBtn);
        loCell.appendChild(loBtn);

        const value = getRowValue(row);

        const valueText = document.createElement("span");
        valueText.className = "value-text";

        if (value === row.target && (row.hi !== 0 || row.lo !== 0)) {
          valueCell.classList.add("correct");
        } else if (row.hi !== 0 || row.lo !== 0) {
          valueCell.classList.add("incorrect");
        }

        valueText.innerHTML = `<span class="mono-preview">${toHex2(
          value
        )}</span> = ${value}`;

        const rowResetBtn = document.createElement("button");
        rowResetBtn.className = "row-reset-btn";
        rowResetBtn.textContent = "Reset values";
        rowResetBtn.dataset.role = "rowreset";

        valueCell.appendChild(valueText);
        valueCell.appendChild(rowResetBtn);

        rowEl.appendChild(targetCell);
        rowEl.appendChild(hiCell);
        rowEl.appendChild(loCell);
        rowEl.appendChild(valueCell);

        gridEl.appendChild(rowEl);
      });

      updateProgressBar();
    }

    function startGame() {
      if (running) return;
      running = true;
      statusEl.textContent =
        "Game running... click the hex digits to match each target.";
      statusEl.className = "status-line important";
      startBtn.textContent = "Pause";

      spawnRow();
      const speed = parseInt(speedSelect.value, 10);
      spawnTimer = setInterval(spawnRow, speed);
    }

    function pauseGame() {
      running = false;
      startBtn.textContent = "Resume";
      statusEl.textContent = "Paused. Click Resume to continue.";
      statusEl.className = "status-line important";

      if (spawnTimer) {
        clearInterval(spawnTimer);
        spawnTimer = null;
      }
    }

    function resetGame() {
      running = false;
      if (spawnTimer) {
        clearInterval(spawnTimer);
        spawnTimer = null;
      }

      rows = [];
      nextId = 1;
      score = 0;
      rowsSolved = 0;
      updateScores();
      renderRows();

      startBtn.textContent = "Start";
      statusEl.textContent =
        "Press Start to begin. Match each target using hex.";
      statusEl.className = "status-line important";
    }

    function gameOver(message) {
      running = false;
      if (spawnTimer) {
        clearInterval(spawnTimer);
        spawnTimer = null;
      }

      startBtn.textContent = "Start";
      statusEl.textContent = `${message} Final score: ${score}.`;
      statusEl.className = "status-line error";
    }

    function buildHowToContent() {
      const title = "How to play: Decimal → Hex";
      const intro = "Turn each decimal target into a matching hexadecimal value.";
      const bullets = [
        "Look at the number in the left column (decimal).",
        "Click the left and right hex digit buttons to change them.",
        "Your goal is to make a hex value that equals the decimal number.",
        "Rows solved on Slow = 5 points, Normal = 10, Fast = 20.",
        "Every 8 correct rows, the numbers get a little larger."
      ];

      howToTitleEl.textContent = title;
      howToIntroEl.textContent = intro;
      howToListEl.innerHTML = "";
      bullets.forEach((text) => {
        const li = document.createElement("li");
        li.textContent = text;
        howToListEl.appendChild(li);
      });
    }

    function openHowTo() {
      buildHowToContent();
      howToOverlay.classList.add("visible");
    }

    function closeHowTo() {
      howToOverlay.classList.remove("visible");
    }

    startBtn.addEventListener("click", () => {
      if (!running && rows.length === 0) {
        startGame();
      } else if (running) {
        pauseGame();
      } else {
        startGame();
      }
    });

    resetBtn.addEventListener("click", () => {
      resetGame();
    });

    speedSelect.addEventListener("change", () => {
      if (running) {
        if (spawnTimer) clearInterval(spawnTimer);
        const speed = parseInt(speedSelect.value, 10);
        spawnTimer = setInterval(spawnRow, speed);
      }
    });

    soundToggle.addEventListener("change", () => {
      soundOn = soundToggle.checked;
    });

    gridEl.addEventListener("click", (event) => {
      const target = event.target;
      const rowEl = target.closest(".grid-row");
      if (!rowEl) return;
      const rowId = parseInt(rowEl.dataset.id, 10);

      if (target.dataset.role === "rowreset") {
        const row = rows.find((r) => r.id === rowId);
        if (!row) return;
        resetRowValues(row);
        renderRows();
        return;
      }

      if (!target.classList.contains("hex-digit")) return;

      const nibble = target.dataset.nibble;
      handleDigitClick(rowId, nibble);
    });

    howToBtn.addEventListener("click", openHowTo);
    closeHowToBtn.addEventListener("click", closeHowTo);
    howToBackdrop.addEventListener("click", closeHowTo);

    resetGame();
  </script>
</body>
</html>
